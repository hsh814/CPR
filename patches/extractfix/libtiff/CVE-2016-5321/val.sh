#!/bin/bash
CPR_DIR=${CPR_DIR:-/root/projects/CPR}
PATH=$PATH:$CPR_DIR/tools
LIB_DIR=$CPR_DIR/lib
# prepare-pacfix.py synth 5321
# pacfix uni -i memory -l ../../live-variables.uni-klee.txt -f ../../live_variables -o result.sbsv
rm -rf val-src val-runtime
mkdir -p val-runtime
project_url=https://github.com/vadz/libtiff.git
commit_id=0ba5d88
git clone $project_url val-src
pushd val-src
  git checkout $commit_id
  cp ../tiffcrop.val.c tools/tiffcrop.c
  ./autogen.sh
  CC=wllvm CXX=wllvm++ ./configure 
  CC=wllvm CXX=wllvm++ make CFLAGS="-static -fsanitize=address -fsanitize=undefined -g -L$LIB_DIR -luni_klee_memory_check" CXXFLAGS="-static -fsanitize=address -fsanitize=undefined -g -L$LIB_DIR -luni_klee_memory_check"  LDFLAGS="-lc -fsanitize=address -fsanitize=undefined -L$LIB_DIR -luni_klee_memory_check" -j 32
  cp tools/tiffcrop.c ../val-runtime
  cp tools/tiffcrop ../val-runtime
popd

pushd val-runtime
  extract-bc tiffcrop
  llvm-dis tiffcrop.bc
popd