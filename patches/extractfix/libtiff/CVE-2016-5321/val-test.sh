#!/bin/bash
CPR_DIR=${CPR_DIR:-/root/projects/CPR}
LIB_DIR=$CPR_DIR/lib
PATH=$PATH:$CPR_DIR/tools
# prepare-pacfix.py synth 5321
# pacfix uni -i memory -l ../../live-variables.uni-klee.txt -f ../../live_variables -o result.sbsv
pushd val-src
  make clean
  CC=clang CXX=clang++ make CFLAGS="-static -fsanitize=address -fsanitize=undefined -g -L$LIB_DIR -luni_klee_memory_check" CXXFLAGS="-static -fsanitize=address -fsanitize=undefined -g -L$LIB_DIR -luni_klee_memory_check" LDFLAGS="-fsanitize=address -fsanitize=undefined" -j10 -j 32
popd
echo "############## Running the test ##############"
UNI_KLEE_MEM_RESULT=/root/projects/CPR/patches/extractfix/libtiff/CVE-2016-5321/patched/result.txt UNI_KLEE_MEM_BASE_FILE=/root/projects/CPR/patches/extractfix/libtiff/CVE-2016-5321/patched/uni-m-out-11/base-mem.graph UNI_KLEE_MEM_FILE=/root/projects/CPR/patches/extractfix/libtiff/CVE-2016-5321/patched/uni-m-out-11/test001990.mem val-src/tools/tiffcrop ./exploit.tif /tmp/out.tf
